<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Mi Perfil</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">

  <!-- Tarjeta de cabecera: avatar + nombre + ubicación + rating -->
  <div class="profile-header">
    <div class="avatar">
      <img [src]="'https://ui-avatars.com/api/?name=' + (user?.name || 'User') + '&background=0ea5e9&color=fff&size=128'"
           alt="avatar">
    </div>
    <div class="info">
      <h2>{{ user?.name || 'Usuario' }}</h2>
      <p class="location">
        <ion-icon name="location-outline"></ion-icon>
        {{ user?.colonia || 'Sin colonia' }}, {{ user?.municipio || 'Sin municipio' }}
      </p>

      <div class="rating-row">
        <span *ngFor="let s of stars; let i = index"
              [class.filled]="isFilledStar(i+1)">★</span>
        <small class="score">{{ ratingAvg | number:'1.1-2' }}/5</small>
        <small class="count">({{ ratingCount }} calif.)</small>
      </div>
    </div>
  </div>

  <!-- Botón flotante para publicar -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button color="primary" (click)="irAPublicar()">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <!-- Productos publicados -->
  <ion-list>
    <ion-list-header>
      <ion-label>Mis productos</ion-label>
    </ion-list-header>
  </ion-list>

  <div class="products-grid" *ngIf="products?.length; else noProducts">
    <div class="product-card" *ngFor="let p of products">
      <div class="thumb">
        <img [src]="(p.images?.length ? (imageBaseUrl + p.images[0].image_path) : 'https://picsum.photos/300/200?random=' + p.id)"
             alt="{{ p.name }}">
      </div>
      <div class="details">
        <h4>{{ p.name }}</h4>
        <span class="status" [class.disponible]="p.status === 'disponible'"
                             [class.intercambiado]="p.status === 'intercambiado'">
          {{ p.status | titlecase }}
        </span>
      </div>
    </div>
  </div>

  <ng-template #noProducts>
    <div class="empty">
      <ion-icon name="cube-outline"></ion-icon>
      <p>Aún no has publicado productos</p>
    </div>
  </ng-template>

  <!-- Historial de calificaciones recibidas -->
  <ion-accordion-group>
    <ion-accordion value="ratings">
      <ion-item slot="header" color="light">
        <ion-label>Historial de calificaciones recibidas</ion-label>
      </ion-item>
      <div class="ratings-list" slot="content">
        <div class="rating-item" *ngFor="let r of ratings">
          <div class="rater">
            <img [src]="'https://ui-avatars.com/api/?name=' + (r.rater?.name || 'User') + '&background=9ca3af&color=fff&size=64'"
                 alt="rater">
            <div>
              <h5>{{ r.rater?.name || 'Usuario' }}</h5>
              <small>{{ r.created_at | date:'medium' }}</small>
            </div>
          </div>
          <div class="stars">
            <span *ngFor="let s of stars; let i = index" [class.filled]="(i+1) <= r.value">★</span>
            <small class="value">{{ r.value }}/5</small>
          </div>
          <p class="comment" *ngIf="r.comment">{{ r.comment }}</p>
        </div>

        <div class="empty" *ngIf="!ratings.length">
          <ion-icon name="star-outline"></ion-icon>
          <p>Aún no has recibido calificaciones</p>
        </div>
      </div>
    </ion-accordion>
  </ion-accordion-group>

</ion-content>
